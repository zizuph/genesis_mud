/*
 * Support shadow for the magic vulnerability spell
 */

#pragma strict_types
#pragma save_binary

#include <stdproperties.h>
#include <ss_types.h>
#include <macros.h>
#include <wa_types.h>
#include <files.h>
#include "/d/Krynn/common/defs.h"
#include "../defs.h"

inherit "/d/Genesis/specials/std/spells/obj/propchange_base_sh";

int magic_vulnerability;
object wohs_caster;
string element_desc;

/*
 * Function:    initialize_shadow
 * Description: Called after first cloned. Should do all the initialization
 *              effects for this particular shadow.
 */

public void
initialize_shadow(object spell_object, mapping spell_input)
{
    ::initialize_shadow(spell_object, spell_input);
    spell_object->set_spell_effect_desc("arcane vulnerability");
    spell_object->set_short("arcane vulnerability curse object");

    wohs_caster = spell_object->query_effect_caster();

    if(!wohs_caster->query_prop("_wohs_plythusuiaerl_prop"))
      element_desc = "magic";
    else
      element_desc = wohs_caster->query_prop("_wohs_plythusuiaerl_prop");

    string moon_bonus = SOHM_MANAGER->query_wohs_moon_phase_aid(wohs_caster);

    int power = spell_object->query_spell_effect_power();

    // reduction in resistance is capped based on spell power
    // and the phases of the magic moons.

    if(wohs_caster->query_wohs_alignment_penalty())
      magic_vulnerability = 0 - (max(1, min(29, power / 8))); // 25% penalty
    else if(moon_bonus == "night of the eye")
      magic_vulnerability = 0 - (max(1, min(51, power / 8))); // 40% bonus
    else if(moon_bonus == "maximum")
      magic_vulnerability = 0 - (max(1, min(46, power / 8))); // 25% bonus
    else if(moon_bonus == "partial")
      magic_vulnerability = 0 - (max(1, min(40, power / 8))); // 10% bonus
    else if(moon_bonus == "none")
      magic_vulnerability = 0 - (max(1, min(37, power / 8))); // base protection
    else if(moon_bonus == "partial_penalty")
      magic_vulnerability = 0 - (max(1, min(34, power / 8))); // 10% penalty
    else if(moon_bonus == "penalty")
      magic_vulnerability = 0 - (max(1, min(29, power / 8))); // 25% penalty

    // magic_vulnerability = 0 - (max(1, min(37, power / 8)));
    // base magic_vulnerability = 37;

    // Duration for power 300 is between 50 to approx 150

    int duration = power / 3; 
    duration = (duration / 2) + random(duration / 2) + random(duration / 2);
    spell_object->set_dispel_time(duration);

    // DEBUG("Magic vulnerability: " +magic_vulnerability+ ", power: "+power+ ", duration: " +duration+ ".");
    // DEBUG("Magic vulnerability, moon phase : " +moon_bonus+ ".");

}

/* 
 * Function:    query_prop
 * Description: This is the primary function that you should override to
 *              implement the propchange shadow. Make sure to return
 *              the shadow_who->query_prop(prop) result if you don't
 *              want to handle that particular prop.
 */
public mixed
query_prop(string prop)
{
    mixed result = shadow_who->query_prop(prop);
    string element = wohs_caster->query_prop("_wohs_plythusuiaerl_prop"); 
    int wohs_level = wohs_caster->query_guild_level_occ();

    if(!element)
        element = "fire";
 
    string resistance_prop = "_obj_magic_i_res_" + element;

    if (prop != resistance_prop)
    {
        return result;
    }
    
    if (intp(result))
    {
        return magic_vulnerability;
    }
    else 
    {
        return 1;
    }
}

/*
 * Function:    hook_spell_effect_started
 * Description: Override this to customize the message when this spell effect
 *              is added to th target.
 */
public void
hook_spell_effect_started(object spell_object)
{
    object target = spell_object->query_effect_target();
    int wohs_level = wohs_caster->query_guild_level_occ();

    if (objectp(target))
    {
        target->catch_tell("You feel yourself cursed with a vulnerability to " 
           +element_desc+" magic.\n");
        tell_room(environment(target), QCTNAME(target) + " is cursed with "
            + "a vulnerability to " +element_desc+ " magic.\n", ({ target }));
    }
    
}

/*
 * Function:    hook_spell_effect_ended
 * Description: Override this to customize the message when this spell effect
 *              is dispelled.
 */
public void
hook_spell_effect_ended(object spell_object)
{
    object target = spell_object->query_effect_target();

    if(target->query_ghost())
        return;

    if (objectp(target))
    {
        target->catch_tell("You feel your curse of arcane vulnerability disappear.\n");
        tell_room(environment(target), QCTNAME(target) + " is no longer " +
           "affected by a curse of arcane vulnerability.\n", ({ target }));
    }

}

/*
 * Function:    hook_spell_effect_warn_fading
 * Description: Override this to customize the message for when
 *              the effect has only a minute left.
 */
public void
hook_spell_effect_warn_fading(object spell_object)
{
    object target = spell_object->query_effect_target();
    
    if (objectp(target))
    {
        target->catch_tell("You feel the curse of arcane vulnerability begin to "
            + "fade.\n");
    }
}

/* 
 * Function:    hook_spell_effect_not_maintained
 * Description: Override this to describe the effect when the caster
 *              cannot maintain the effect.
 */
public void
hook_spell_effect_not_maintained(object spell_object)
{
    object caster = spell_object->query_effect_caster();
    
    if (objectp(caster))
    {
        caster->catch_tell("You are mentally unable to maintain "
            + "the curse of arcane vulnerability.\n");
    }    
}
